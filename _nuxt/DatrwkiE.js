import{a as m}from"./B-RZKRZT.js";import{u as A}from"./CLStg_Nh.js";const v=(e,t)=>t.some(n=>e instanceof n);let E,C;function F(){return E||(E=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function T(){return C||(C=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const I=new WeakMap,b=new WeakMap,w=new WeakMap;function O(e){const t=new Promise((n,r)=>{const c=()=>{e.removeEventListener("success",s),e.removeEventListener("error",a)},s=()=>{n(f(e.result)),c()},a=()=>{r(e.error),c()};e.addEventListener("success",s),e.addEventListener("error",a)});return w.set(t,e),t}function R(e){if(I.has(e))return;const t=new Promise((n,r)=>{const c=()=>{e.removeEventListener("complete",s),e.removeEventListener("error",a),e.removeEventListener("abort",a)},s=()=>{n(),c()},a=()=>{r(e.error||new DOMException("AbortError","AbortError")),c()};e.addEventListener("complete",s),e.addEventListener("error",a),e.addEventListener("abort",a)});I.set(e,t)}let D={get(e,t,n){if(e instanceof IDBTransaction){if(t==="done")return I.get(e);if(t==="store")return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return f(e[t])},set(e,t,n){return e[t]=n,!0},has(e,t){return e instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in e}};function P(e){D=e(D)}function k(e){return T().includes(e)?function(...t){return e.apply(_(this),t),f(this.request)}:function(...t){return f(e.apply(_(this),t))}}function V(e){return typeof e=="function"?k(e):(e instanceof IDBTransaction&&R(e),v(e,F())?new Proxy(e,D):e)}function f(e){if(e instanceof IDBRequest)return O(e);if(b.has(e))return b.get(e);const t=V(e);return t!==e&&(b.set(e,t),w.set(t,e)),t}const _=e=>w.get(e);function K(e,t,{blocked:n,upgrade:r,blocking:c,terminated:s}={}){const a=indexedDB.open(e,t),i=f(a);return r&&a.addEventListener("upgradeneeded",o=>{r(f(a.result),o.oldVersion,o.newVersion,f(a.transaction),o)}),n&&a.addEventListener("blocked",o=>n(o.oldVersion,o.newVersion,o)),i.then(o=>{s&&o.addEventListener("close",()=>s()),c&&o.addEventListener("versionchange",u=>c(u.oldVersion,u.newVersion,u))}).catch(()=>{}),i}const W=["get","getKey","getAll","getAllKeys","count"],G=["put","add","delete","clear"],S=new Map;function L(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t=="string"))return;if(S.get(t))return S.get(t);const n=t.replace(/FromIndex$/,""),r=t!==n,c=G.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!(c||W.includes(n)))return;const s=async function(a,...i){const o=this.transaction(a,c?"readwrite":"readonly");let u=o.store;return r&&(u=u.index(i.shift())),(await Promise.all([u[n](...i),c&&o.done]))[0]};return S.set(t,s),s}P(e=>({...e,get:(t,n,r)=>L(t,n)||e.get(t,n,r),has:(t,n)=>!!L(t,n)||e.has(t,n)}));const X=["continue","continuePrimaryKey","advance"],p={},B=new WeakMap,x=new WeakMap,Q={get(e,t){if(!X.includes(t))return e[t];let n=p[t];return n||(n=p[t]=function(...r){B.set(this,x.get(this)[t](...r))}),n}};async function*U(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;t=t;const n=new Proxy(t,Q);for(x.set(n,t),w.set(n,_(t));t;)yield n,t=await(B.get(n)||t.continue()),B.delete(n)}function M(e,t){return t===Symbol.asyncIterator&&v(e,[IDBIndex,IDBObjectStore,IDBCursor])||t==="iterate"&&v(e,[IDBIndex,IDBObjectStore])}P(e=>({...e,get(t,n,r){return M(t,n)?U:e.get(t,n,r)},has(t,n){return M(t,n)||e.has(t,n)}}));const $="iptvMovieLibrary",z=1;async function N(){return await K($,z,{upgrade(t){t.objectStoreNames.contains("categories")||t.createObjectStore("categories",{keyPath:"category_id"}),t.objectStoreNames.contains("movies")||t.createObjectStore("movies",{keyPath:"stream_id"}).createIndex("by_category","_category_id",{unique:!1}),t.objectStoreNames.contains("meta")||t.createObjectStore("meta",{keyPath:"key"})}})}async function H(e,t,n){const r=await N(),c=r.transaction("categories","readwrite"),s=c.objectStore("categories");await s.clear();for(const d of e)await s.put(d);await c.done;const a=r.transaction("movies","readwrite"),i=a.objectStore("movies");await i.clear();for(const d of t){const g=d.category.category_id;for(const y of d.movies){const h={...y,_category_id:g};await i.put(h)}}await a.done;const o=r.transaction("meta","readwrite");await o.objectStore("meta").put({key:"main",lastSync:n}),await o.done}async function J(){const e=await N(),t=await e.getAll("categories"),n=await e.get("meta","main");if(!t.length)return{categories:[],rows:[],lastSync:null};const c=await e.transaction("movies","readonly").objectStore("movies").getAll(),s=new Map;for(const i of c){const o=i._category_id;s.has(o)||s.set(o,[]);const{_category_id:u,...d}=i;s.get(o).push(d)}const a=[];for(const i of t){const o=s.get(i.category_id)||[];a.push({category:i,movies:o})}return{categories:t,rows:a,lastSync:n?.lastSync??null}}const Y=["SOCCER","DE -","BE -","PT/BR -","ES -","FR -","LA -","AF -","QC -","IT -","NL -","GR -","NORDIC","SVENSKA","DANSKE","NORGE","MT -","BG -","AL -","EX -","TR -","IR -","SO -","IN -","BN -","PK -","BR -","PL -","EN - ITALIAN SUB ENG"].map(e=>e.toLowerCase()),Z=e=>{const t=e.toLowerCase();return Y.some(n=>t.startsWith(n))},te=()=>{const e=m("libCategories",()=>[]),t=m("libRows",()=>[]),n=m("libLastSync",()=>null),r=m("libIsSyncing",()=>!1),c=m("libSyncError",()=>null),{xtreamFetch:s}=A();return{categories:e,rows:t,lastSync:n,isSyncing:r,syncError:c,loadFromCache:async()=>{try{const{categories:o,rows:u,lastSync:d}=await J();o.length&&(e.value=o,t.value=u,n.value=d)}catch(o){console.error("[movieLibrary] loadFromCache error:",o)}},syncFromXtream:async()=>{r.value=!0,c.value=null;try{const u=(await s({action:"get_vod_categories"})).filter(y=>!Z(y.category_name)),d=[];for(const y of u)try{const j=(await s({action:"get_vod_streams",category_id:y.category_id})).map(l=>({stream_id:l.stream_id,name:l.name,stream_type:l.stream_type,stream_icon:l.stream_icon,rating:l.rating,rating_5based:l.rating_5based,added:l.added,category_id:l.category_id,container_extension:l.container_extension}));d.push({category:y,movies:j})}catch{console.warn("[movieLibrary] skipping category (no response):",y.category_name)}const g=Date.now();await H(u,d,g),e.value=u,t.value=d,n.value=g}catch(o){console.error("[movieLibrary] sync error:",o),c.value=o?.message||"Failed to sync movie library."}finally{r.value=!1}}}};export{te as u};
